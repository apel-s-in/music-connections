=== –û–ë–ó–û–† –ü–†–û–ï–ö–¢–ê ===
–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–µ –°–≤—è–∑–∏ ‚Äî PWA –Ω–∞ Next.js (App Router).
–î–∞–Ω–Ω—ã–µ: YAML/JSON; —Å–±–æ—Ä–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞ –Ω–∞ build-—Å—Ç–∞–¥–∏–∏ (js-yaml + zod).
–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏: –¢–∞–π–º–ª–∞–π–Ω (d3-scale/zoom), –ì—Ä–∞—Ñ (@xyflow/react), –ö–∞—Ä—Ç–∞ (d3-geo, –±–µ–∑ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –≥—Ä–∞–Ω–∏—Ü).
–ü–æ–∏—Å–∫: Fuse + —Ñ–∞—Å–µ—Ç—ã. –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è: RU/EN/ORIG —Å —Ñ–æ–ª–ª–±–µ–∫–æ–º. PWA —Å –æ—Ñ–ª–∞–π–Ω-¬´–∏–∑–±—Ä–∞–Ω–Ω—ã–º¬ª (IndexedDB).
Zero-backend, Cloudflare WAF/Rate Limiting. –ë—ç–∫–∞–ø—ã: rclone ‚Üí –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫.

MVP (–≠—Ç–∞–ø 1): –±–µ–∑ –∞–¥–º–∏–Ω–∫–∏/–ò–ò/PDF; RU –ø–æ–ª–Ω–æ—Å—Ç—å—é; –∏–º–µ–Ω–∞ RU/EN/Orig; —Ç–∞–π–º–ª–∞–π–Ω, –≥—Ä–∞—Ñ, –∫–∞—Ä—Ç–∞; –æ—Ñ–ª–∞–π–Ω-–∏–∑–±—Ä–∞–Ω–Ω–æ–µ.
–≠—Ç–∞–ø 2: –∏—Å—Ç–æ—á–Ω–∏–∫–∏/–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è, –∞–¥–º–∏–Ω–∫–∞, –ò–ò-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø–æ–∏—Å–∫.
–≠—Ç–∞–ø 3: —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π PDF (CJK/RTL), –¥–æ–Ω–∞—Ç—ã.

–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô (–≤–∞–∂–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤):
- –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–æ–≤: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é RU. –ê–Ω–≥–ª–∏–π—Å–∫–∏–π ‚Äî –µ—Å–ª–∏ —è–≤–Ω–æ –ø–æ–ø—Ä–æ—Å—è—Ç –∏–ª–∏ –≤ –∏–º–µ–Ω–∞—Ö/—Ç–µ—Ä–º–∏–Ω–∞—Ö.
- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω—ã–µ –ø—É—Ç–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ —Å—Å—ã–ª–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, src/app/(main)/timeline/page.tsx).
- –õ—é–±–æ–π –∫–æ–¥ –≤—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û –≤ —Ç—Ä–æ–π–Ω—ã—Ö –±—ç–∫—Ç–∏–∫–∞—Ö —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —è–∑—ã–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:
  ```ts
  export function x() {}
  ```
- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç—è–∂–µ–ª–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –†–∞–∑—Ä–µ—à–µ–Ω—ã: —Å–ø–∏—Å–∫–∏, –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã.
- –ï—Å–ª–∏ —Ç—Ä–µ–±—É—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ç—á (unified diff) –∏–ª–∏ —Ü–µ–ª–∏–∫–æ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª (–Ω–µ —Å–º–µ—à–∏–≤–∞—Ç—å).
- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ API. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî —è–≤–Ω–æ —Å–∫–∞–∂–∏ ¬´–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ¬ª.
- –ü–µ—Ä–µ–¥ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –ø—Ä–æ–≤–µ—Ä—è–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (Next 14 App Router, @xyflow/react, d3, next-intl 3.x).
- –ö–æ–º–∞–Ω–¥—ã —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ ‚Äî –≤ –±–ª–æ–∫–∞—Ö ```bash; —Å–µ–∫—Ä–µ—Ç—ã –Ω–µ –ª–æ–≥–∏—Ä—É–π.
- i18n: —É—á–∏—Ç—ã–≤–∞–π RU/EN/ORIG –∏ —Ñ–æ–ª–ª–±–µ–∫–∏ ru‚Üíen‚Üíorig.
- –î–∞—Ç—ã: ISO 8601, —Ç–æ—á–Ω–æ—Å—Ç—å (–≥–æ–¥/–º–µ—Å—è—Ü/–¥–µ–Ω—å), circa, –∫–∞–ª–µ–Ω–¥–∞—Ä—å.
- PDF –≤ MVP ‚Äî —Ç–æ–ª—å–∫–æ print CSS; CJK/RTL –ø–æ–∑–∂–µ (pdfmake/@react-pdf –∏–ª–∏ Puppeteer).
- –°—Ç–∏–ª—å –∫–æ–¥–∞: TypeScript strict, ESM-–∏–º–ø–æ—Ä—Ç—ã, 2 –ø—Ä–æ–±–µ–ª–∞.
- CI/Actions: —Å–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∞–≤—Ç–æ–Ω–æ–º–Ω–∞ –¥–∞–∂–µ –ø—Ä–∏ —Å–ª–æ–º–∞–Ω–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.
- –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–µ—Å—å —Ñ–∞–π–ª —Ü–µ–ª–∏–∫–æ–º; —Ç–æ–ª—å–∫–æ –±–ª–æ–∫–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã —Å–æ —Å—Ç—Ä–æ–≥–∏–º —É–∫–∞–∑–∞–Ω–∏–µ–º –º–µ—Å—Ç–∞.
- –§–æ—Ä–º–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π: -> –§–ê–ô–õ: –ø—É—Ç—å -> –ù–ê–ô–¢–ò: [—Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–æ—Å–ª–æ–≤–Ω–æ] -> –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê: [–ø–æ–ª–Ω—ã–π –Ω–æ–≤—ã–π –±–ª–æ–∫].
- –°–æ—Ö—Ä–∞–Ω—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç-—Å—Ç—Ä—É–∫—Ç—É—Ä—É.
- –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º –±–ª–æ–∫ ‚Äî —É–∫–∞–∂–∏ —Å—Ç—Ä–æ–∫—É –ø–µ—Ä–µ–¥ –∏ —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ (–∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞).
- –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ, —á—Ç–æ –∏ –ø–æ—á–µ–º—É –¥–µ–ª–∞–µ–º.

–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: 2025-11-05 19:29:15 UTC
–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞: 0.1.0

// FILE: /.github/scripts/fallback-generate-context.js
/* eslint-disable no-console */
"use strict";

// Fallback –¥–ª—è .meta ‚Äî —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã (–ø–æ–ª–Ω—ã–π –ø—É—Ç—å) –∏ –ø–æ–ª–Ω—ã–π –∫–æ–¥. –ë–µ–∑ –¥–µ—Ä–µ–≤–∞/–¥–∞—Ç/—Ä–∞–∑–º–µ—Ä–æ–≤.

const fs = require("fs");
const path = require("path");

const ROOT = process.env.GITHUB_WORKSPACE || process.cwd();
const META = path.join(ROOT, ".meta");
if (!fs.existsSync(META)) fs.mkdirSync(META, { recursive: true });

const toUnix = (p) => p.replace(/\\/g, "/");

const BLOCK_DIRS = new Set([
  "node_modules", ".git", ".next", "dist", "build", "out", "coverage",
  ".meta", ".vscode", ".idea", ".cache", ".husky"
]);
const ALLOW_DOT_DIRS = new Set([".github"]);
const TEXT_EXTS = new Set([
  ".ts",".tsx",".js",".jsx",".json",".yaml",".yml",".md",".css",".scss",".less",
  ".txt",".html",".webmanifest",".env",".env.example",".cjs",".mjs",".yml"
]);

function normalizedExt(file) {
  let base = path.basename(file);
  while (base.endsWith(".")) base = base.slice(0, -1);
  return path.extname(base).toLowerCase();
}
function isText(rel) { return TEXT_EXTS.has(normalizedExt(rel)); }

function shouldSkip(rel, name, isDir) {
  const u = toUnix(rel);
  for (const b of BLOCK_DIRS) {
    if (u === b || u.startsWith(`${b}/`) || u.includes(`/${b}/`)) return true;
  }
  if (isDir && name.startsWith(".") && !ALLOW_DOT_DIRS.has(name)) return true;
  return false;
}

function listFiles() {
  const res = [];
  const stack = [ROOT];
  while (stack.length) {
    const d = stack.pop();
    let ents = [];
    try { ents = fs.readdirSync(d, { withFileTypes: true }); } catch { continue; }
    for (const it of ents) {
      const full = path.join(d, it.name);
      const rel = toUnix(path.relative(ROOT, full)) || ".";
      if (shouldSkip(rel, it.name, it.isDirectory())) continue;
      try {
        if (it.isDirectory()) stack.push(full);
        else if (it.isFile()) res.push(rel);
      } catch {}
    }
  }
  return res.sort();
}

function headerBlock() {
  const overview = [
    "–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–µ –°–≤—è–∑–∏ ‚Äî PWA –Ω–∞ Next.js (App Router).",
    "–î–∞–Ω–Ω—ã–µ: YAML/JSON; —Å–±–æ—Ä–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞ (js-yaml + zod). –¢–∞–π–º–ª–∞–π–Ω/d3, –ì—Ä–∞—Ñ/@xyflow/react, –ö–∞—Ä—Ç–∞/d3-geo.",
    "–ü–æ–∏—Å–∫: Fuse + —Ñ–∞—Å–µ—Ç—ã. RU/EN/ORIG. PWA –æ—Ñ–ª–∞–π–Ω (IndexedDB). Zero-backend.",
  ].join("\n");

  const llmRules = [
    "–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô:",
    "- –Ø–∑—ã–∫ ‚Äî RU. –ö–æ–¥ —Ç–æ–ª—å–∫–æ –≤ ```<—è–∑—ã–∫> –±–ª–æ–∫–∞—Ö.",
    "- –°—Å—ã–ª–∞–π—Å—è –Ω–∞ –ø–æ–ª–Ω—ã–µ –ø—É—Ç–∏. –ü–∞—Ç—á–∏ ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∏–ª–∏ —Ü–µ–ª–∏–∫–æ–º —Ñ–∞–π–ª.",
    "- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏; –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö ‚Äî –∑–∞–ø—Ä–æ—Å —É—Ç–æ—á–Ω–µ–Ω–∏–π.",
    "- i18n: RU‚ÜíEN‚ÜíORIG. –î–∞—Ç—ã: ISO 8601, circa, –∫–∞–ª–µ–Ω–¥–∞—Ä—å.",
    "- PDF –≤ MVP ‚Äî print CSS. CI –∫–æ–Ω—Ç–µ–∫—Å—Ç ‚Äî –∞–≤—Ç–æ–Ω–æ–º–µ–Ω.",
    "- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–µ—Å—å —Ñ–∞–π–ª —Ü–µ–ª–∏–∫–æ–º ‚Äî —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –±–ª–æ–∫–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã.",
  ].join("\n");

  const now = new Date().toISOString();
  let version = "0.0.0";
  try { version = require(path.join(ROOT, "package.json")).version || version; } catch {}

  return [
    "=== –û–ë–ó–û–† –ü–†–û–ï–ö–¢–ê ===",
    overview, "", llmRules, "",
    `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${now}`, `–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞: ${version}`, ""
  ].join("\n");
}

function run() {
  const files = listFiles().filter(isText);
  let full = headerBlock();

  for (const rel of files) {
    const label = "/" + toUnix(rel);
    let body = "";
    try { body = fs.readFileSync(path.join(ROOT, rel), "utf8"); }
    catch (e) { body = `// read error: ${e.message}`; }
    full += `\n// FILE: ${label}\n${body}\n`;
  }

  fs.writeFileSync(path.join(META, "project-full.txt"), full, "utf8");

  // adaptive —Ç–∞–∫–æ–π –∂–µ —Ñ–æ—Ä–º–∞—Ç (–±–µ–∑ –æ–±—Ä–µ–∑–∫–∏ ‚Äî fallback –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç)
  fs.writeFileSync(path.join(META, "project-adaptive.txt"), full, "utf8");

  console.log("Fallback generation done (files only, full code).");
}

try { run(); } catch (e) { console.error(e); process.exit(1); }


// FILE: /.github/workflows/auto-sync.yml
name: Auto Sync .meta to meta branch

on:
  schedule:
    - cron: "0 */6 * * *"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: "meta-sync"
  cancel-in-progress: true

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Run repo generator (continue on error)
        id: repo_gen
        continue-on-error: true
        run: |
          mkdir -p .meta
          if [ -f scripts/generate-context.js ]; then
            node scripts/generate-context.js --mode=both --max-lines=20000
          else
            echo "scripts/generate-context.js not found"
            exit 2
          fi

      - name: Run fallback generator (node file)
        if: steps.repo_gen.outcome != 'success'
        run: |
          node .github/scripts/fallback-generate-context.js

      - name: Publish .meta to 'meta' branch
        run: |
          set -e
          BRANCH=meta
          git fetch origin $BRANCH || true
          if git show-ref --quiet refs/heads/$BRANCH; then
            echo "Branch $BRANCH exists"
          else
            git branch $BRANCH || true
          fi
          git worktree add _meta_worktree $BRANCH || true
          rsync -a --delete .meta/ _meta_worktree/
          cd _meta_worktree
          if [ -n "$(git status --porcelain)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add -A
            git commit -m "chore(meta): refresh context"
            git push origin $BRANCH || echo "Push failed ‚Äî check branch protections"
          else
            echo "No changes for meta branch"
          fi


// FILE: /.github/workflows/generate-context.yml
name: Generate Context (.meta)

on:
  push:
    branches: [ main ]
    paths-ignore:
      - ".meta/**"
  pull_request:
    branches: [ main ]
    paths-ignore:
      - ".meta/**"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: "generate-context-${{ github.ref_name }}"
  cancel-in-progress: true

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Run repo generator (continue on error)
        id: repo_gen
        continue-on-error: true
        run: |
          mkdir -p .meta
          if [ -f scripts/generate-context.js ]; then
            node scripts/generate-context.js --mode=both --max-lines=20000
          else
            echo "scripts/generate-context.js not found"
            exit 2
          fi

      - name: Run fallback generator (node file)
        if: steps.repo_gen.outcome != 'success'
        run: |
          node .github/scripts/fallback-generate-context.js

      - name: Commit .meta on push to main
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          if [ -n "$(git status --porcelain .meta)" ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add .meta
            git commit -m "chore(meta): update project context"
            git push || echo "Push failed (branch may be protected)"
          else
            echo "No changes in .meta"
          fi

      - name: Upload .meta as artifact on PR
        if: github.event_name == 'pull_request'
        uses: actions/upload-artifact@v4
        with:
          name: meta-files
          path: .meta/


// FILE: /package.json
{
  "name": "music-connections",
  "version": "0.1.0",
  "private": true,
  "description": "–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–µ —Å–≤—è–∑–∏ ‚Äî PWA (Next.js). –î–∞–Ω–Ω—ã–µ YAML/JSON. –¢–∞–π–º–ª–∞–π–Ω, –≥—Ä–∞—Ñ, –∫–∞—Ä—Ç–∞. RU/EN/ORIG.",
  "scripts": {
    "generate:context": "node scripts/generate-context.js --mode=both --max-lines=20000",
    "generate:context:full": "node scripts/generate-context.js --mode=full",
    "generate:context:adaptive": "node scripts/generate-context.js --mode=adaptive --max-lines=20000"
  },
  "engines": {
    "node": ">=16.14"
  },
  "license": "MIT"
}


// FILE: /scripts/generate-context.js
/* eslint-disable no-console */
"use strict";

/**
 * –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ .meta:
 * - .meta/project-full.txt  ‚Äî –∑–∞–≥–æ–ª–æ–≤–æ–∫ + —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã (–ø–æ–ª–Ω—ã–π –ø—É—Ç—å) + –ø–æ–ª–Ω—ã–π –∫–æ–¥
 * - .meta/project-adaptive.txt ‚Äî —Ç–æ –∂–µ, –Ω–æ —É—Å–µ—á–µ–Ω–æ –ø–æ –ª–∏–º–∏—Ç—É –∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º
 * –ë–µ–∑ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.
 */

const fs = require("fs");
const path = require("path");

// --------------------- CLI ---------------------
const argv = Object.fromEntries(
  process.argv.slice(2).map((arg) => {
    const [k, ...rest] = arg.replace(/^--/, "").split("=");
    return [k, rest.join("=") === "" ? true : rest.join("=")];
  })
);

const PROJECT_ROOT = path.resolve(argv.root || path.join(__dirname, ".."));
const META_DIR = path.resolve(argv["out-dir"] || path.join(PROJECT_ROOT, ".meta"));
const MODE = (argv.mode || "both").toLowerCase(); // full | adaptive | both
const ADAPTIVE_MAX_LINES = Number(argv["max-lines"] || 20000);

if (!fs.existsSync(META_DIR)) fs.mkdirSync(META_DIR, { recursive: true });

const FULL_FILE = path.join(META_DIR, "project-full.txt");
const ADAPTIVE_FILE = path.join(META_DIR, "project-adaptive.txt");

// --------------------- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---------------------
const CONFIG = {
  scanExclude: [
    "node_modules/**",
    ".git/**",
    ".next/**",
    "dist/**",
    "build/**",
    "out/**",
    "coverage/**",
    ".meta/**",
    ".vscode/**",
    ".idea/**",
    ".cache/**",
    ".husky/**",
    "**/*.log",
    "**/*.tmp",
    ".DS_Store",
    ".eslintcache",
    ".prettiercache",
  ],
  // –¢–µ–∫—Å—Ç–æ–≤—ã–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è (–≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ –ø—Ä–æ–ø—É—Å–∫–∞–µ–º)
  textExts: new Set([
    ".ts",".tsx",".js",".jsx",".json",".yaml",".yml",".md",".css",".scss",".less",
    ".txt",".html",".webmanifest",".env",".env.example",".cjs",".mjs",".yml"
  ]),
  // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã (–¥–ª—è adaptive)
  priorityRules: {
    critical: [
      /^schema\/properties\.yaml$/,
      /^data\/people\/.*\.(yaml|yml)$/,
      /^data\/works\/.*\.(yaml|yml)$/,
      /^data\/instruments\/.*\.(yaml|yml)$/,
      /^data\/places\/.*\.(yaml|yml)$/,
      /^data\/events\/.*\.(yaml|yml)$/,
      /^scripts\/build-connections\.(ts|js)$/,
      /^src\/types\/dataset\.(ts|js)$/,
      /^src\/lib\/data-loader\.(ts|js)$/,
      /^src\/lib\/offline\.(ts|js)$/,
      /^src\/components\/timeline\/.*\.(tsx?|jsx?)$/,
      /^src\/components\/graph\/.*\.(tsx?|jsx?)$/,
      /^src\/components\/map\/.*\.(tsx?|jsx?)$/,
      /^src\/app\/.*\.(tsx?|jsx?)$/,
      /^public\/manifest\.(json|webmanifest)$/,
      /^next\.config\.js$/,
      /^package\.json$/,
      /^tsconfig\.json$/,
      /^tailwind\.config\.js$/,
      /^postcss\.config\.js$/,
      /^\.github\/workflows\/generate-context\.yml$/,
      /^\.github\/workflows\/auto-sync\.yml$/,
    ],
    high: [
      /^src\/i18n\/messages\/.*\.json$/,
      /^data\/locales\/.*\.json$/,
      /^public\/data\/.*\.json$/,
      /^src\/styles\/.*\.css$/,
      /^README\.md$/,
    ],
    medium: [
      /^src\/lib\/.*\.(ts|js)$/,
      /^src\/components\/.*\.(tsx?|jsx?)$/,
      /^scripts\/generate-context\.(ts|js)$/,
      /^\.github\/workflows\/.*\.yml$/,
      /^public\/geo\/.*$/,
    ],
  },
  adaptiveLimits: {
    maxLines: ADAPTIVE_MAX_LINES,
    criticalPercentage: 60,
    highPercentage: 25,
    mediumPercentage: 15,
  },
};

// --------------------- .mccontextignore ---------------------
function loadUserIgnore() {
  const file = path.join(PROJECT_ROOT, ".mccontextignore");
  if (!fs.existsSync(file)) return [];
  try {
    const raw = fs.readFileSync(file, "utf8");
    return raw.split("\n").map((l)=>l.trim()).filter((l)=>l && !l.startsWith("#"));
  } catch { return []; }
}

const EXTRA_EXCLUDE = loadUserIgnore();

// --------------------- –£—Ç–∏–ª–∏—Ç—ã ---------------------
const toUnix = (p) => p.replace(/\\/g, "/");
const globToRegExp = (pattern) => {
  const esc = pattern
    .replace(/[.+^${}()|[\]\\]/g,"\\$")
    .replace(/\*\*/g,"___GLOBSTAR___")
    .replace(/\*/g,"[^/]*")
    .replace(/___GLOBSTAR___/g,".*");
  return new RegExp(`^${esc}$`);
};
const EXCLUDE_PATTERNS = CONFIG.scanExclude.concat(EXTRA_EXCLUDE).map(globToRegExp);
const isExcluded = (rel) => EXCLUDE_PATTERNS.some((re)=>re.test(toUnix(rel)));

function normalizedExt(file) {
  let base = path.basename(file);
  while (base.endsWith(".")) base = base.slice(0, -1);
  return path.extname(base).toLowerCase();
}
function isTextFile(rel) {
  return CONFIG.textExts.has(normalizedExt(rel));
}

function getAllProjectFiles() {
  const files = [];
  const stack = [PROJECT_ROOT];
  while (stack.length) {
    const dir = stack.pop();
    let items = [];
    try { items = fs.readdirSync(dir, { withFileTypes: true }); } catch { continue; }
    for (const it of items) {
      const full = path.join(dir, it.name);
      const rel = toUnix(path.relative(PROJECT_ROOT, full)) || ".";
      // –∏—Å–∫–ª—é—á–∞–µ–º –ª—é–±—ã–µ —Å–∫—Ä—ã—Ç—ã–µ –∫–∞—Ç–∞–ª–æ–≥–∏ (–Ω–∞—á–∏–Ω–∞—é—Ç—Å—è —Å .), –∫—Ä–æ–º–µ .github
      if (it.isDirectory() && it.name.startsWith(".") && it.name !== ".github") continue;
      if (isExcluded(rel)) continue;
      try {
        if (it.isDirectory()) stack.push(full);
        else if (it.isFile()) files.push(rel);
      } catch {}
    }
  }
  return files.sort((a,b)=>a.localeCompare(b));
}

function readFileText(rel) {
  const abs = path.join(PROJECT_ROOT, rel);
  try { return fs.readFileSync(abs, "utf8"); }
  catch (e) { return `// read error: ${e.message}`; }
}

function countLines(s){ return (s.match(/\n/g)||[]).length + (s.length?1:0); }

function getFilePriority(rel) {
  const unix = toUnix(rel);
  for (const [level, rules] of Object.entries(CONFIG.priorityRules)) {
    if (rules.some((re)=>re.test(unix))) return level;
  }
  return "low";
}

// --------------------- –ó–∞–≥–æ–ª–æ–≤–æ–∫ ---------------------
function headerBlock(){
  const now = new Date().toISOString().replace("T"," ").slice(0,19);
  let version="0.0.0";
  try { version = require(path.join(PROJECT_ROOT, "package.json")).version || version; } catch {}

  const overview = [
    "–ú—É–∑—ã–∫–∞–ª—å–Ω—ã–µ –°–≤—è–∑–∏ ‚Äî PWA –Ω–∞ Next.js (App Router).",
    "–î–∞–Ω–Ω—ã–µ: YAML/JSON; —Å–±–æ—Ä–∫–∞ –¥–∞—Ç–∞—Å–µ—Ç–∞ –Ω–∞ build-—Å—Ç–∞–¥–∏–∏ (js-yaml + zod).",
    "–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏: –¢–∞–π–º–ª–∞–π–Ω (d3-scale/zoom), –ì—Ä–∞—Ñ (@xyflow/react), –ö–∞—Ä—Ç–∞ (d3-geo, –±–µ–∑ –ø–æ–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –≥—Ä–∞–Ω–∏—Ü).",
    "–ü–æ–∏—Å–∫: Fuse + —Ñ–∞—Å–µ—Ç—ã. –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è: RU/EN/ORIG —Å —Ñ–æ–ª–ª–±–µ–∫–æ–º. PWA —Å –æ—Ñ–ª–∞–π–Ω-¬´–∏–∑–±—Ä–∞–Ω–Ω—ã–º¬ª (IndexedDB).",
    "Zero-backend, Cloudflare WAF/Rate Limiting. –ë—ç–∫–∞–ø—ã: rclone ‚Üí –Ø–Ω–¥–µ–∫—Å.–î–∏—Å–∫.",
  ].join("\n");

  const llmRules = [
    "–ü–†–ê–í–ò–õ–ê –î–õ–Ø –ù–ï–ô–†–û–°–ï–¢–ï–ô (–≤–∞–∂–Ω–æ –¥–ª—è –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤):",
    "- –Ø–∑—ã–∫ –æ—Ç–≤–µ—Ç–æ–≤: –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é RU. –ê–Ω–≥–ª–∏–π—Å–∫–∏–π ‚Äî –µ—Å–ª–∏ —è–≤–Ω–æ –ø–æ–ø—Ä–æ—Å—è—Ç –∏–ª–∏ –≤ –∏–º–µ–Ω–∞—Ö/—Ç–µ—Ä–º–∏–Ω–∞—Ö.",
    "- –í—Å–µ–≥–¥–∞ —É–∫–∞–∑—ã–≤–∞–π —Ç–æ—á–Ω—ã–µ –ø—É—Ç–∏ —Ñ–∞–π–ª–æ–≤ –ø—Ä–∏ —Å—Å—ã–ª–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, src/app/(main)/timeline/page.tsx).",
    "- –õ—é–±–æ–π –∫–æ–¥ –≤—ã–≤–æ–¥–∏ –¢–û–õ–¨–ö–û –≤ —Ç—Ä–æ–π–Ω—ã—Ö –±—ç–∫—Ç–∏–∫–∞—Ö —Å —É–∫–∞–∑–∞–Ω–∏–µ–º —è–∑—ã–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä:",
    "  ```ts",
    "  export function x() {}",
    "  ```",
    "- –ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ç—è–∂–µ–ª–æ–µ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ. –†–∞–∑—Ä–µ—à–µ–Ω—ã: —Å–ø–∏—Å–∫–∏, –∫–æ—Ä–æ—Ç–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã.",
    "- –ï—Å–ª–∏ —Ç—Ä–µ–±—É—é—Ç—Å—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª–µ ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–π –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–∞—Ç—á (unified diff) –∏–ª–∏ —Ü–µ–ª–∏–∫–æ–º –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–π —Ñ–∞–π–ª (–Ω–µ —Å–º–µ—à–∏–≤–∞—Ç—å).",
    "- –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –∏ API. –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç ‚Äî —è–≤–Ω–æ —Å–∫–∞–∂–∏ ¬´–Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ¬ª.",
    "- –ü–µ—Ä–µ–¥ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –ø—Ä–æ–≤–µ—Ä—è–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å (Next 14 App Router, @xyflow/react, d3, next-intl 3.x).",
    "- –ö–æ–º–∞–Ω–¥—ã —Ç–µ—Ä–º–∏–Ω–∞–ª–∞ ‚Äî –≤ –±–ª–æ–∫–∞—Ö ```bash; —Å–µ–∫—Ä–µ—Ç—ã –Ω–µ –ª–æ–≥–∏—Ä—É–π.",
    "- i18n: —É—á–∏—Ç—ã–≤–∞–π RU/EN/ORIG –∏ —Ñ–æ–ª–ª–±–µ–∫–∏ ru‚Üíen‚Üíorig.",
    "- –î–∞—Ç—ã: ISO 8601, —Ç–æ—á–Ω–æ—Å—Ç—å (–≥–æ–¥/–º–µ—Å—è—Ü/–¥–µ–Ω—å), circa, –∫–∞–ª–µ–Ω–¥–∞—Ä—å.",
    "- PDF –≤ MVP ‚Äî —Ç–æ–ª—å–∫–æ print CSS; CJK/RTL –ø–æ–∑–∂–µ (pdfmake/@react-pdf –∏–ª–∏ Puppeteer).",
    "- –°—Ç–∏–ª—å –∫–æ–¥–∞: TypeScript strict, ESM-–∏–º–ø–æ—Ä—Ç—ã, 2 –ø—Ä–æ–±–µ–ª–∞.",
    "- CI/Actions: —Å–±–æ—Ä–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∞–≤—Ç–æ–Ω–æ–º–Ω–∞ –¥–∞–∂–µ –ø—Ä–∏ —Å–ª–æ–º–∞–Ω–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.",
    "- –ù–ò–ö–û–ì–î–ê –Ω–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤–µ—Å—å —Ñ–∞–π–ª —Ü–µ–ª–∏–∫–æ–º; —Ç–æ–ª—å–∫–æ –±–ª–æ–∫–∏ –¥–ª—è –∑–∞–º–µ–Ω—ã —Å–æ —Å—Ç—Ä–æ–≥–∏–º —É–∫–∞–∑–∞–Ω–∏–µ–º –º–µ—Å—Ç–∞.",
    "- –§–æ—Ä–º–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π: -> –§–ê–ô–õ: –ø—É—Ç—å -> –ù–ê–ô–¢–ò: [—Ñ—Ä–∞–≥–º–µ–Ω—Ç –¥–æ—Å–ª–æ–≤–Ω–æ] -> –ó–ê–ú–ï–ù–ò–¢–¨ –ù–ê: [–ø–æ–ª–Ω—ã–π –Ω–æ–≤—ã–π –±–ª–æ–∫].",
    "- –°–æ—Ö—Ä–∞–Ω—è–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏–º–ø–æ—Ä—Ç-—Å—Ç—Ä—É–∫—Ç—É—Ä—É.",
    "- –ï—Å–ª–∏ —É–¥–∞–ª—è–µ–º –±–ª–æ–∫ ‚Äî —É–∫–∞–∂–∏ —Å—Ç—Ä–æ–∫—É –ø–µ—Ä–µ–¥ –∏ —Å—Ç—Ä–æ–∫—É –ø–æ—Å–ª–µ (–∏–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞).",
    "- –í—Å–µ–≥–¥–∞ –ø–∏—à–∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ, —á—Ç–æ –∏ –ø–æ—á–µ–º—É –¥–µ–ª–∞–µ–º.",
  ].join("\n");

  const mvp = [
    "MVP (–≠—Ç–∞–ø 1): –±–µ–∑ –∞–¥–º–∏–Ω–∫–∏/–ò–ò/PDF; RU –ø–æ–ª–Ω–æ—Å—Ç—å—é; –∏–º–µ–Ω–∞ RU/EN/Orig; —Ç–∞–π–º–ª–∞–π–Ω, –≥—Ä–∞—Ñ, –∫–∞—Ä—Ç–∞; –æ—Ñ–ª–∞–π–Ω-–∏–∑–±—Ä–∞–Ω–Ω–æ–µ.",
    "–≠—Ç–∞–ø 2: –∏—Å—Ç–æ—á–Ω–∏–∫–∏/–æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è, –∞–¥–º–∏–Ω–∫–∞, –ò–ò-—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏, –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø–æ–∏—Å–∫.",
    "–≠—Ç–∞–ø 3: —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π PDF (CJK/RTL), –¥–æ–Ω–∞—Ç—ã.",
  ].join("\n");

  return [
    "=== –û–ë–ó–û–† –ü–†–û–ï–ö–¢–ê ===",
    overview, "", mvp, "", llmRules, "",
    `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${now} UTC`, `–í–µ—Ä—Å–∏—è –ø—Ä–æ–µ–∫—Ç–∞: ${version}`, ""
  ].join("\n");
}

// --------------------- FULL ---------------------
function generateFullFile() {
  let content = headerBlock();
  const all = getAllProjectFiles().filter(isTextFile);
  for (const rel of all) {
    const label = "/" + toUnix(rel); // –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –æ—Ç –∫–æ—Ä–Ω—è —Ä–µ–ø–æ
    content += `\n// FILE: ${label}\n${readFileText(rel)}\n`;
  }
  return content;
}

// --------------------- ADAPTIVE ---------------------
function generateAdaptiveFile() {
  const MAX = CONFIG.adaptiveLimits.maxLines;
  let content = headerBlock();
  let current = countLines(content);

  const allText = getAllProjectFiles().filter(isTextFile);
  const by = (lvl) => allText.filter((f)=>getFilePriority(f)===lvl);

  const order = [
    ["critical", Math.floor(MAX * (CONFIG.adaptiveLimits.criticalPercentage / 100))],
    ["high", Math.floor(MAX * ((CONFIG.adaptiveLimits.criticalPercentage + CONFIG.adaptiveLimits.highPercentage) / 100))],
    ["medium", MAX],
  ];

  for (const [lvl, limit] of order) {
    for (const rel of by(lvl)) {
      const block = `\n// FILE: /${toUnix(rel)}\n${readFileText(rel)}\n`;
      const lines = countLines(block);
      if (current + lines > limit) break;
      content += block; current += lines;
    }
  }

  if (countLines(content) > MAX) {
    const lines = content.split("\n").slice(0, MAX);
    content = lines.join("\n");
  }
  return content;
}

// --------------------- MAIN ---------------------
function main(){
  console.log(`üîß –ö–æ—Ä–µ–Ω—å –ø—Ä–æ–µ–∫—Ç–∞: ${PROJECT_ROOT}`);
  console.log(`üìÇ –ü–∞–ø–∫–∞ –≤—ã–≤–æ–¥–∞: ${META_DIR}`);
  console.log(`üß≠ –†–µ–∂–∏–º: ${MODE}`);
  if (MODE === "full" || MODE === "both") {
    const full = generateFullFile();
    fs.writeFileSync(FULL_FILE, full, "utf8");
    console.log(`‚úÖ ${FULL_FILE} –≥–æ—Ç–æ–≤`);
  }
  if (MODE === "adaptive" || MODE === "both") {
    const adaptive = generateAdaptiveFile();
    fs.writeFileSync(ADAPTIVE_FILE, adaptive, "utf8");
    console.log(`‚úÖ ${ADAPTIVE_FILE} –≥–æ—Ç–æ–≤`);
  }
  console.log("üéâ –ì–æ—Ç–æ–≤–æ!");
}

try { main(); } catch (e) { console.error("‚ùå –û—à–∏–±–∫–∞:", e); process.exit(1); }

